# API Platform Customizations

We've recently tried out API Platform - a REST and GraphQL Framework based on Symfony and React,
and we are extremely happy with using it so far.

## Fixing Docker Container Restart (API Platform 2.5 Hotfix)

```
curl -L https://github.com/sandstorm/api-platform-customizations/raw/master/01_fix_docker_container_restart.patch | patch -p1
git add .
git commit -m "BUGFIX: apply 01_fix_docker_container_restart.patch"
```

We had some trouble in restarting all containers, i.e. when doing docker-compose stop and then
again docker-compose up, not all containers would come up. Specifically, the mercure and vulcain
containers would exit, complaining about not-found SSL certificates.

Further investigation shows that the SSL certificates are generated by the dev-tls container,
but the client container overwrites/removes them on startup.

We simply set the dev-certs volume to read-only. This issue has been fixed in the
[API-Platform master branch](https://github.com/api-platform/api-platform/commit/ef05822b07ca57eb28665fe965043961373661e5#diff-4e5e90c6228fd48698d074241c2ba760)
already, so the fix will be included in API-Platform 2.6.


## A more coarse-grained deployment approach

By default, an API Platform production deployment consists of 4-6 different containers,
which need to be connected together. For big deployments, that's definitely a great setup.
However, for us, we often have low-traffic APIs, where we want to develop and deploy as easily
as possible. Thus, we are a big fan of reducing the number of parts to-be-deployed, using
fewer, but bigger, docker containers.

The following sections explain what needs to be changed for a good experience with
deploying the application as a "monolith".


## Moving the API into the /api sub-path

By default, the HTTP API is available in the root of the server. For API-first projects, this
is fine; however, in our case we often want to show a UI at the server root; and move the API
a bit further down.

We've experimented a lot on how to move the nested server path, trying all sorts of Nginx
configuration to make this work. Ultimately, I could not make it reliably work just with Nginx
configuration; thus our approach now is to re-configure the Symfony routes a bit, and tweaking
the entrypoint URLs for Admin and the Client:

```
curl -L https://github.com/sandstorm/api-platform-customizations/raw/master/02_api_subdirectory.patch | patch -p1
git add .
git commit -m "TASK: apply 02_api_subdirectory.patch"
```

## Combine Nginx and PHP

For production, we want to deploy only a single container with the full application. For making
Development and Production as similar as possible, we need to bundle the Nginx and PHP containers
together, optionally with including Vulcain as well.

```
curl -L https://github.com/sandstorm/api-platform-customizations/raw/master/03_combine_nginx_php.patch | patch -p1
git add .
git commit -m "TASK: apply 03_combine_nginx_php.patch"
```

## Disable Vulcain, Mercure and Varnish

For a simple setup, let's remove Vulcain, Mercure and Varnish. We'll be able re-enable them in later
steps in a different way.

```
curl -L https://github.com/sandstorm/api-platform-customizations/raw/master/04_disable_vulcain_mercure_varnish.patch | patch -p1
git add .
git commit -m "TASK: apply 04_disable_vulcain_mercure_varnish.patch"
```

## Add Production Build

Here, we add a production build based on gitlab-ci.

```
curl -L https://github.com/sandstorm/api-platform-customizations/raw/master/05_add_prod_build.patch | patch -p1
git add .
git commit -m "TASK: apply 05_add_prod_build.patch"
```

## (Optional, untested yet) Add Mercure Hub to the PHP container

```
curl -L https://github.com/sandstorm/api-platform-customizations/raw/master/06_add_mercure_hub_to_php_container.patch | patch -p1
git add .
git commit -m "TASK: apply 06_add_mercure_hub_to_php_container.patch"
```

## (Optional, untested yet) Add Vulcain to the PHP container

```
curl -L https://github.com/sandstorm/api-platform-customizations/raw/master/07_add_vulcain_to_php_container.patch | patch -p1
git add .
git commit -m "TASK: apply 07_add_vulcain_to_php_container.patch"
```